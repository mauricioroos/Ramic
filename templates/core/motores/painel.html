{% extends "core/base.html" %}
{% load static %}

{% block content %}
<h2 class="mb-1">Acionamento de Motores</h2>
<p class="text-muted">Motores Industriais</p>

<form class="mb-3" method="get">
  <div class="input-group">
    <input type="text" class="form-control" name="q" placeholder="Pesquisar motor" value="{{ q }}">
    <button class="btn btn-outline-secondary" type="submit">üîé</button>
  </div>
</form>

<style>
    .image-container {
        position: relative;
    }
    .status-indicator {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 2px solid white;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
  
    @keyframes pulse-animation {
        0% { box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.4); }
        70% { box-shadow: 0 0 0 10px rgba(0, 0, 0, 0); }
        100% { box-shadow: 0 0 0 0 rgba(0, 0, 0, 0); }
    }
    .blinking-indicator {
        animation: pulse-animation 1.5s infinite;
    }
</style>

<div class="row g-3">
  {% for motor in motores %}
  <div class="col-12 col-md-6 col-lg-4 col-xl-3">
    <div class="card shadow-sm h-100">
      
      <div class="image-container">
        {% if motor.imagem %}
          <img src="{{ motor.imagem.url }}" class="card-img-top ramic-card-img" alt="{{ motor.nome }}">
        {% else %}
          <div class="ramic-card-img d-flex align-items-center justify-content-center bg-light">
            <i class="bi bi-image" style="font-size: 5rem; color: #e9ecef;"></i>
          </div>
        {% endif %}

        <div class="status-indicator {% if motor.ligado or motor.em_manutencao %}blinking-indicator{% endif %}" 
             style="{% if motor.em_manutencao %}background-color: #ffc107;{% elif motor.ligado %}background-color: #198754;{% else %}background-color: #dc3545;{% endif %}"
             title="{% if motor.em_manutencao %}Em Manuten√ß√£o{% elif motor.ligado %}Ligado{% else %}Desligado{% endif %}">
        </div>
      </div>

      <div class="card-body d-flex flex-column">
        <h5 class="card-title mb-1">{{ motor.nome }}</h5>
        
        <div class="small text-muted mb-3 flex-grow-1">
          <div><strong>Modelo:</strong> <span class="text-dark"><strong>{{ motor.modelo|default:"‚Äî" }}</strong></span></div>
          <div><strong>Localiza√ß√£o:</strong> <span class="text-dark"><strong>{{ motor.localizacao|default:"‚Äî" }}</strong></span></div>
          <div><strong>Serial:</strong> <span class="text-dark"><strong>{{ motor.numero_serie }}</strong></span></div>

          {% if motor.descricao %}
            <div class="mt-2"><strong>Descri√ß√£o:</strong> <span class="text-dark"><strong>{{ motor.descricao }}</strong></span></div>
          {% endif %}
          <div class="row gx-3 mt-2 text-center">
              <div class="col">
                <small class="text-muted">Pot√™ncia</small><br>
                <strong class="text-dark">{{ motor.potencia|default:"‚Äî" }} W</strong>
              </div>
              <div class="col">
                <small class="text-muted">Tens√£o</small><br>
                <strong class="text-dark">{{ motor.tensao|default:"‚Äî" }} V</strong>
              </div>
              <div class="col">
                <small class="text-muted">Corrente</small><br>
                <strong class="text-dark">{{ motor.corrente|default:"‚Äî" }} A</strong>
              </div>
          </div>
        </div>
        
        <div class="mb-3">
          <strong>Status:</strong>
          {% if motor.em_manutencao %}
            <span class="badge text-bg-warning">Em Manuten√ß√£o</span>
          {% elif motor.ligado %}
            <span class="badge text-bg-success">Ligado</span>
          {% else %}
            <span class="badge text-bg-secondary">Desligado</span>
          {% endif %}
        </div>

        <div class="d-flex align-items-center justify-content-between mt-auto">
            <div class="d-flex align-items-center gap-2">
                {% if not motor.em_manutencao %}
                    {% if motor.ligado %}
                        <form method="POST" action="{% url 'desligar_motor' motor.id %}">{% csrf_token %}<button type="submit" class="btn btn-warning btn-sm">Desligar</button></form>
                    {% else %}
                        <form method="POST" action="{% url 'ligar_motor' motor.id %}">{% csrf_token %}<button type="submit" class="btn btn-success btn-sm">Ligar</button></form>
                    {% endif %}
                {% else %}
                    <button type="button" class="btn btn-secondary btn-sm" disabled>Ligar</button>
                {% endif %}
                <a href="{% url 'historico' motor.id %}" class="btn btn-info btn-sm">Hist√≥rico</a>
            </div>
        
            <div class="d-flex align-items-center gap-2">
                <span id="status-icon-online-{{ motor.id }}" style="display: none;" title="Conectado ao Arduino"><i class="bi bi-wifi h5 text-success mb-0"></i></span>
                <span id="status-icon-offline-{{ motor.id }}" title="Desconectado do Arduino"><i class="bi bi-wifi-off h5 text-muted mb-0"></i></span>
        
                {% if user.is_staff %}
                <div class="dropdown">
                    <button class="btn btn-secondary btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false"> ‚ãÆ </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'editar_motor' motor.id %}">Editar</a></li>
                        <li><hr class="dropdown-divider"></li>
                        {% if motor.em_manutencao %}
                            <li><form method="POST" action="{% url 'desativar_manutencao' motor.id %}">{% csrf_token %}<button type="submit" class="dropdown-item">‚úÖ Retirar de Manuten√ß√£o</button></form></li>
                        {% else %}
                            <li><form method="POST" action="{% url 'ativar_manutencao' motor.id %}">{% csrf_token %}<button type="submit" class="dropdown-item">‚ö†Ô∏è Colocar em Manuten√ß√£o</button></form></li>
                        {% endif %}
                        <li><hr class="dropdown-divider"></li>
                        <li><form method="POST" action="{% url 'apagar_motor' motor.id %}" onsubmit="return confirm('Tem certeza que deseja apagar o motor \'{{ motor.nome|escapejs }}\'?');">{% csrf_token %}<button type="submit" class="dropdown-item text-danger">Apagar</button></form></li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
    <div class="col-12">
        <div class="card card-body text-center">
            <p class="mb-0">Nenhum motor cadastrado. <a href="{% url 'adicionar_motor' %}">Adicionar o primeiro motor agora</a>.</p>
        </div>
    </div>
  {% endfor %}
</div>
    
<script>
// verifica o status do WiFi continua aqui.
</script>
{% endblock %}